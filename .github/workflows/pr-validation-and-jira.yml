name: Validate PR and Create Jira Task

on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened

jobs:
  validate-and-jira:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout do CÃ³digo do PR (com submÃ³dulos)
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Garantir que os SubmÃ³dulos EstÃ£o Atualizados
        run: git submodule update --init --recursive

      - name: Verificar a Branch Atual (Confirma PR)
        run: git branch --show-current

      - name: Debug - Listar Arquivos na Pasta `rules`
        run: ls -R rules/

      - name: Debug - Exibir Caminho Completo do `swagger.yaml`
        run: |
          echo "Listando arquivos no diretÃ³rio atual:"
          ls -lah
          echo "Procurando por swagger.yaml:"
          find $(pwd) -name "swagger.yaml"

      - name: Garantir PermissÃµes de Leitura no `swagger.yaml`
        run: chmod +r swagger.yaml || true

      - name: Instalar DependÃªncias do Go
        run: |
          go mod init validator || true
          go mod tidy
          go get github.com/pb33f/libopenapi

      - name: Rodar PB33F e gerar relatÃ³rio usando `rules/validator.go`
        run: |
          echo "ðŸ” Buscando swagger.yaml..."
          if [ ! -f "swagger.yaml" ]; then
            echo "âŒ Arquivo swagger.yaml nÃ£o encontrado na versÃ£o do PR!"
            exit 1
          fi

          if [ ! -f "rules/validator.go" ]; then
            echo "âŒ Arquivo validator.go nÃ£o encontrado em rules/!"
            exit 1
          fi

          echo "âœ… Arquivo encontrado: swagger.yaml"
          echo "ðŸŸ¢ Executando validaÃ§Ã£o PB33F..."

          go run rules/validator.go swagger.yaml > pb33f_report.txt 2>&1 || true

          echo "âœ… PB33F finalizado com sucesso!"

      - name: Instalar Spectral para validaÃ§Ã£o OpenAPI
        run: npm install -g @stoplight/spectral-cli

      - name: Rodar Spectral e gerar relatÃ³rio usando `rules/spectral_rules.yaml`
        run: |
          if [ ! -f "swagger.yaml" ]; then
            echo "âŒ Arquivo swagger.yaml nÃ£o encontrado na versÃ£o do PR!"
            exit 1
          fi

          if [ ! -f "rules/spectral_rules.yaml" ]; then
            echo "âŒ Arquivo de regras do Spectral nÃ£o encontrado!"
            exit 1
          fi

          echo "âœ… Arquivo encontrado: swagger.yaml"
          spectral lint swagger.yaml --ruleset rules/spectral_rules.yaml > spectral_report.txt 2>&1 || true

          echo "âœ… Spectral finalizado com sucesso! Erros e warnings foram salvos no relatÃ³rio."

      - name: Instalar Vale CLI para validaÃ§Ã£o de documentaÃ§Ã£o
        run: |
          echo "ðŸ”½ Baixando e instalando Vale CLI..."
          VALE_VERSION=$(curl -s https://api.github.com/repos/errata-ai/vale/releases/latest | jq -r .tag_name)
          curl -L -o vale.tar.gz "https://github.com/errata-ai/vale/releases/download/$VALE_VERSION/vale_${VALE_VERSION:1}_Linux_64-bit.tar.gz"
          tar -xzf vale.tar.gz
          sudo mv vale /usr/local/bin/
          vale --version

      - name: Garantir que a pasta `rules/styles/` existe
        run: |
          if [ ! -d "rules/styles" ]; then
            echo "âš ï¸ Criando a pasta rules/styles/ para evitar erro no Vale CLI..."
            mkdir -p rules/styles
          fi

      - name: Rodar Vale CLI e gerar relatÃ³rio usando `rules/.vale.ini`
        run: |
          if [ ! -f "swagger.yaml" ]; then
            echo "âŒ Arquivo swagger.yaml nÃ£o encontrado na versÃ£o do PR!"
            exit 1
          fi

          if [ ! -f "rules/.vale.ini" ]; then
            echo "âŒ Arquivo de configuraÃ§Ã£o .vale.ini nÃ£o encontrado!"
            exit 1
          fi

          echo "âœ… Arquivo encontrado: swagger.yaml"
          vale --config rules/.vale.ini "swagger.yaml" > vale_report.txt || true

      - name: Criar Task no Jira
        id: create-jira-task
        env:
          JIRA_URL: ${{ secrets.JIRA_URL }}
          JIRA_USER: ${{ secrets.JIRA_USER }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_PROJECT: ${{ secrets.JIRA_PROJECT }}
          JIRA_ISSUE_TYPE: "Bug"
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_URL="${{ github.event.pull_request.html_url }}"
          PR_AUTHOR="${{ github.event.pull_request.user.login }}"

          DESCRIPTION="Este ticket foi gerado automaticamente para revisar o PR: $PR_TITLE. \n\nðŸ”— Link do PR: $PR_URL \nðŸ‘¤ Criado por: $PR_AUTHOR"

          ISSUE_PAYLOAD=$(cat <<EOF
          {
            "fields": {
              "project": { "key": "$JIRA_PROJECT" },
              "summary": "RevisÃ£o do PR: $PR_TITLE",
              "description": "$DESCRIPTION",
              "issuetype": { "name": "$JIRA_ISSUE_TYPE" }
            }
          }
          EOF
          )

          RESPONSE=$(curl -s -X POST -H "Content-Type: application/json" \
            -u "$JIRA_USER:$JIRA_API_TOKEN" \
            --data "$ISSUE_PAYLOAD" "$JIRA_URL/rest/api/2/issue/")

          ISSUE_KEY=$(echo $RESPONSE | jq -r '.key')
          echo "JIRA_ISSUE_KEY=$ISSUE_KEY" >> $GITHUB_ENV
          echo "âœ… Tarefa Jira criada: $ISSUE_KEY"

      - name: Anexar RelatÃ³rios na Task Jira
        env:
          JIRA_URL: ${{ secrets.JIRA_URL }}
          JIRA_USER: ${{ secrets.JIRA_USER }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        run: |
          ISSUE_KEY="${{ env.JIRA_ISSUE_KEY }}"
          for FILE in pb33f_report.txt spectral_report.txt vale_report.txt; do
            if [[ -f "$FILE" ]]; then
              curl -X POST -H "X-Atlassian-Token: no-check" \
                -H "Content-Type: multipart/form-data" \
                -u "$JIRA_USER:$JIRA_API_TOKEN" \
                -F "file=@$FILE" "$JIRA_URL/rest/api/2/issue/$ISSUE_KEY/attachments"
            fi
          done
