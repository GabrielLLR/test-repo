name: Validate PR and Create Jira Task

on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened

jobs:
  validate-and-jira:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout do C√≥digo do PR (com subm√≥dulos)
        uses: actions/checkout@v4
        with:
          submodules: true  # Garante que a pasta `rules` seja clonada corretamente
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Garantir que os Subm√≥dulos Est√£o Atualizados
        run: git submodule update --init --recursive

      - name: Verificar a Branch Atual (Confirma PR)
        run: git branch --show-current

      - name: Debug - Listar Arquivos na Pasta `rules`
        run: ls -R rules/

      - name: Debug - Exibir Caminho Completo do `swagger.yaml`
        run: |
          echo "Listando arquivos no diret√≥rio atual:"
          ls -lah
          echo "Procurando por swagger.yaml:"
          find $(pwd) -name "swagger.yaml"

      - name: Garantir Permiss√µes de Leitura no `swagger.yaml`
        run: chmod +r swagger.yaml || true

      - name: Instalar Depend√™ncias do Go
        run: |
          go mod init validator || true
          go mod tidy
          go get github.com/pb33f/libopenapi

      - name: Rodar PB33F e gerar relat√≥rio usando `rules/validator.go`
        run: |
          echo "üîç Buscando swagger.yaml..."
          if [ ! -f "swagger.yaml" ]; then
            echo "‚ùå Arquivo swagger.yaml n√£o encontrado na vers√£o do PR!"
            exit 1
          fi

          if [ ! -f "rules/validator.go" ]; then
            echo "‚ùå Arquivo validator.go n√£o encontrado em rules/!"
            exit 1
          fi

          echo "‚úÖ Arquivo encontrado: swagger.yaml"
          echo "üü¢ Executando valida√ß√£o PB33F..."

          go run rules/validator.go swagger.yaml > pb33f_report.txt 2>&1 || {
            echo "‚ùå Erro ao executar PB33F. Veja detalhes abaixo:"
            cat pb33f_report.txt
            exit 1
          }

          echo "‚úÖ PB33F finalizado com sucesso!"

      - name: Instalar Spectral para valida√ß√£o OpenAPI
        run: npm install -g @stoplight/spectral-cli

      - name: Rodar Spectral e gerar relat√≥rio usando `rules/spectral_rules.yaml`
        run: |
          if [ ! -f "swagger.yaml" ]; then
            echo "‚ùå Arquivo swagger.yaml n√£o encontrado na vers√£o do PR!"
            exit 1
          fi

          if [ ! -f "rules/spectral_rules.yaml" ]; then
            echo "‚ùå Arquivo de regras do Spectral n√£o encontrado!"
            exit 1
          fi

          echo "‚úÖ Arquivo encontrado: swagger.yaml"
          spectral lint swagger.yaml --ruleset rules/spectral_rules.yaml > spectral_report.txt || {
            echo "‚ùå Erro ao executar Spectral. Veja detalhes abaixo:"
            cat spectral_report.txt
            exit 1
          }

          echo "‚úÖ Spectral finalizado com sucesso!"

      - name: Instalar Vale CLI para valida√ß√£o de documenta√ß√£o
        run: |
          curl -fsSL https://install.vale.sh | sh
          vale --version

      - name: Rodar Vale CLI e gerar relat√≥rio
        run: |
          if [ ! -f "swagger.yaml" ]; then
            echo "‚ùå Arquivo swagger.yaml n√£o encontrado na vers√£o do PR!"
            exit 1
          fi

          echo "‚úÖ Arquivo encontrado: swagger.yaml"
          vale "swagger.yaml" > vale_report.txt

      - name: Upload de Relat√≥rios de Valida√ß√£o no GitHub
        uses: actions/upload-artifact@v4
        with:
          name: validation-reports
          path: |
            pb33f_report.txt
            spectral_report.txt
            vale_report.txt
