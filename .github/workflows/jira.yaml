name: Jira Task Creation

on:
  workflow_call:

jobs:
  jira:
    runs-on: ubuntu-latest
    steps:
      - name: Criar Task no Jira
        id: create-jira-task
        env:
          JIRA_URL: ${{ secrets.JIRA_URL }}
          JIRA_USER: ${{ secrets.JIRA_USER }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_PROJECT: ${{ secrets.JIRA_PROJECT }}
          JIRA_ISSUE_TYPE: "Task"
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_URL="${{ github.event.pull_request.html_url }}"
          PR_AUTHOR="${{ github.event.pull_request.user.login }}"

          DESCRIPTION=$(jq -Rs '.' <<< "Revis√£o do PR: $PR_TITLE. Link do PR: $PR_URL Criado por: $PR_AUTHOR")

          ISSUE_PAYLOAD=$(jq -n \
            --arg project "$JIRA_PROJECT" \
            --arg summary "Revis√£o do PR: $PR_TITLE" \
            --arg description "$DESCRIPTION" \
            --arg issuetype "$JIRA_ISSUE_TYPE" \
            '{ fields: { project: { key: $project }, summary: $summary, description: $description | fromjson, issuetype: { name: $issuetype } } }')

          echo "üìù Criando issue no Jira..."
          RESPONSE=$(curl -s -X POST -H "Content-Type: application/json" \
            -u "$JIRA_USER:$JIRA_API_TOKEN" \
            --data "$ISSUE_PAYLOAD" "$JIRA_URL/rest/api/2/issue/")

          echo "üîç Resposta da API do Jira: $RESPONSE"
          echo "$RESPONSE" | jq .

          ISSUE_KEY=$(echo "$RESPONSE" | jq -r '.key // empty')

          if [[ -z "$ISSUE_KEY" ]]; then
            echo "‚ùå Erro ao criar issue no Jira! Resposta completa: $RESPONSE"
            exit 1
          fi

          echo "JIRA_ISSUE_KEY=$ISSUE_KEY" >> $GITHUB_ENV
          echo "‚úÖ Tarefa Jira criada: $ISSUE_KEY"

      - name: Mover Issue para 'Para Desenvolvimento'
        env:
          JIRA_URL: ${{ secrets.JIRA_URL }}
          JIRA_USER: ${{ secrets.JIRA_USER }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        run: |
          ISSUE_KEY="${{ env.JIRA_ISSUE_KEY }}"

          if [ -z "$ISSUE_KEY" ]; then
            echo "‚ùå Nenhuma issue Jira foi criada. Pulando transi√ß√£o."
            exit 1
          fi

          echo "üîÑ Obtendo transi√ß√µes dispon√≠veis para a issue $ISSUE_KEY..."
          TRANSITIONS=$(curl -s -X GET -H "Content-Type: application/json" \
            -u "$JIRA_USER:$JIRA_API_TOKEN" "$JIRA_URL/rest/api/2/issue/$ISSUE_KEY/transitions")

          echo "üîÑ Poss√≠veis transi√ß√µes: $TRANSITIONS"

          TRANSITION_ID="51" # Substituir se necess√°rio com o ID correto

          TRANSITION_PAYLOAD=$(jq -n --arg transition "$TRANSITION_ID" '{ transition: { id: $transition } }')

          TRANSITION_RESPONSE=$(curl -s -X POST -H "Content-Type: application/json" \
            -u "$JIRA_USER:$JIRA_API_TOKEN" \
            --data "$TRANSITION_PAYLOAD" "$JIRA_URL/rest/api/2/issue/$ISSUE_KEY/transitions")

          echo "üîÑ Resposta da API de Transi√ß√£o: $TRANSITION_RESPONSE"

      - name: Anexar Relat√≥rios na Task Jira
        env:
          JIRA_URL: ${{ secrets.JIRA_URL }}
          JIRA_USER: ${{ secrets.JIRA_USER }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        run: |
          ISSUE_KEY="${{ env.JIRA_ISSUE_KEY }}"

          if [[ -z "$ISSUE_KEY" ]]; then
            echo "‚ùå Nenhuma issue Jira foi criada. Pulando anexos."
            exit 1
          fi

          for FILE in pb33f_report.txt spectral_report.txt vale_report.txt; do
            if [[ -f "$FILE" ]]; then
              echo "üìé Anexando $FILE √† issue $ISSUE_KEY..."
              curl -X POST -H "X-Atlassian-Token: no-check" \
                -H "Content-Type: multipart/form-data" \
                -u "$JIRA_USER:$JIRA_API_TOKEN" \
                -F "file=@$FILE" "$JIRA_URL/rest/api/2/issue/$ISSUE_KEY/attachments"
            fi
          done
